<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ chapter.name }} - {{ story.title }} - Manga Heaven</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="reader-body">
    <!-- Reader Header -->
    <header class="reader-header" id="readerHeader">
        <div class="reader-nav">
            <a href="/story/{{ manga_id }}" class="back-btn">
                <span class="back-icon">â†</span>
                <span class="back-text hide-mobile">{{ story.title }}</span>
            </a>

            <div class="chapter-selector">
                <select id="chapterSelect" class="chapter-select">
                    {% for chap in story.chapters %}
                    <option value="{{ chap.id }}" {% if chap.id==chapter.id %}selected{% endif %}>
                        {{ chap.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="reader-controls">
                {% if prev_chapter %}
                <a href="/reader/{{ manga_id }}/{{ prev_chapter.id }}" class="nav-btn" title="Chapter trÆ°á»›c">
                    <span class="hide-mobile">â†</span> TrÆ°á»›c
                </a>
                {% else %}
                <span class="nav-btn disabled"><span class="hide-mobile">â†</span> TrÆ°á»›c</span>
                {% endif %}

                {% if next_chapter %}
                <a href="/reader/{{ manga_id }}/{{ next_chapter.id }}" class="nav-btn" title="Chapter sau">
                    Sau <span class="hide-mobile">â†’</span>
                </a>
                {% else %}
                <span class="nav-btn disabled">Sau <span class="hide-mobile">â†’</span></span>
                {% endif %}
                
                {% if current_user.is_authenticated %}
                <div class="user-dropdown reader-user-dropdown">
                    <button class="user-dropdown-btn compact" onclick="toggleUserMenu()">
                        <span class="user-avatar-small">{{ current_user.username[0].upper() }}</span>
                    </button>
                    <div class="user-dropdown-menu" id="userDropdown">
                        <a href="/account" class="dropdown-item">âš™ï¸ CÃ i Ä‘áº·t</a>
                        {% if current_user.is_admin() %}
                        <a href="/admin" class="dropdown-item">ğŸ“Š Admin</a>
                        {% endif %}
                        <div class="dropdown-divider"></div>
                        <a href="/logout" class="dropdown-item dropdown-item-danger">ğŸšª ÄÄƒng xuáº¥t</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </header>

    <!-- Reader Content -->
    <main class="reader-content" id="readerContent">
        <div class="reader-container">
            {% if images %}
            {% for img in images %}
            <div class="page-wrapper">
                {% if is_cloud_urls %}
                <!-- áº¢nh tá»« ImageKit Cloud -->
                <img src="{{ img }}" alt="Trang {{ loop.index }}" class="page-image" loading="lazy"
                    data-page="{{ loop.index }}">
                {% else %}
                <!-- áº¢nh tá»« Local Storage -->
                <img src="/cdn/{{ manga_id }}/{{ chapter.id }}/{{ img }}" alt="Trang {{ loop.index }}"
                    class="page-image" loading="lazy" data-page="{{ loop.index }}">
                {% endif %}
                <span class="page-number">{{ loop.index }} / {{ images|length }}</span>
            </div>
            {% endfor %}
            {% else %}
            <div class="loading-chapter">
                <div class="spinner"></div>
                <h3>Äang táº£i chapter...</h3>
                <p>Vui lÃ²ng Ä‘á»£i, áº£nh Ä‘ang Ä‘Æ°á»£c táº£i vá» server</p>
                <button id="retryBtn" class="btn btn-primary" style="margin-top: 20px;">
                    ğŸ”„ Táº£i láº¡i
                </button>
            </div>
            {% endif %}
        </div>
    </main>

    <!-- Bottom Navigation -->
    <footer class="reader-footer" id="readerFooter">
        <div class="footer-nav">
            {% if prev_chapter %}
            <a href="/reader/{{ manga_id }}/{{ prev_chapter.id }}" class="footer-btn prev">
                <span class="btn-icon">â†</span>
                <span class="btn-text">{{ prev_chapter.name }}</span>
            </a>
            {% else %}
            <div class="footer-btn disabled">
                <span class="btn-text">ÄÃ¢y lÃ  chapter Ä‘áº§u tiÃªn</span>
            </div>
            {% endif %}

            <a href="/story/{{ manga_id }}" class="footer-btn home">
                <span class="btn-icon">ğŸ“‘</span>
                <span class="btn-text">Danh sÃ¡ch</span>
            </a>

            {% if next_chapter %}
            <a href="/reader/{{ manga_id }}/{{ next_chapter.id }}" class="footer-btn next">
                <span class="btn-text">{{ next_chapter.name }}</span>
                <span class="btn-icon">â†’</span>
            </a>
            {% else %}
            <div class="footer-btn disabled">
                <span class="btn-text">ÄÃ£ lÃ  chapter má»›i nháº¥t</span>
            </div>
            {% endif %}
        </div>
    </footer>

    <!-- Floating Controls -->
    <div class="floating-controls" id="floatingControls">
        <button class="float-btn toggle-float-btn" id="toggleFloatBtn" title="áº¨n nÃºt Ä‘iá»u khiá»ƒn">Ã—</button>
        <div class="float-buttons" id="floatButtons">
            <button class="float-btn" id="scrollTopBtn" title="LÃªn Ä‘áº§u trang">â†‘</button>
            <button class="float-btn" id="toggleUIBtn" title="áº¨n/Hiá»‡n UI">ğŸ‘ï¸</button>
            <button class="float-btn" id="scrollBottomBtn" title="Xuá»‘ng cuá»‘i">â†“</button>
        </div>
    </div>

    <!-- Progress Bar -->
    <div class="reading-progress" id="progressBar"></div>

    <script>
        // Auto-hide floating controls after 3 seconds
        let floatAutoHideTimer;
        const floatingControls = document.getElementById('floatingControls');
        
        function resetFloatAutoHide() {
            floatingControls?.classList.remove('auto-hidden');
            clearTimeout(floatAutoHideTimer);
            floatAutoHideTimer = setTimeout(() => {
                floatingControls?.classList.add('auto-hidden');
            }, 3000);
        }
        
        // Show on scroll/touch, auto-hide after 3s
        window.addEventListener('scroll', resetFloatAutoHide);
        window.addEventListener('touchstart', resetFloatAutoHide);
        resetFloatAutoHide();
        
        // Toggle floating buttons visibility
        let floatVisible = true;
        document.getElementById('toggleFloatBtn')?.addEventListener('click', () => {
            floatVisible = !floatVisible;
            const floatButtons = document.getElementById('floatButtons');
            const toggleBtn = document.getElementById('toggleFloatBtn');
            floatButtons.classList.toggle('hidden', !floatVisible);
            toggleBtn.textContent = floatVisible ? 'Ã—' : 'â˜°';
            toggleBtn.title = floatVisible ? 'áº¨n nÃºt Ä‘iá»u khiá»ƒn' : 'Hiá»‡n nÃºt Ä‘iá»u khiá»ƒn';
            resetFloatAutoHide();
        });
        
        // Chapter selector
        document.getElementById('chapterSelect')?.addEventListener('change', function () {
            window.location.href = `/reader/{{ manga_id }}/${this.value}`;
        });

        // Scroll to top/bottom
        document.getElementById('scrollTopBtn')?.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        document.getElementById('scrollBottomBtn')?.addEventListener('click', () => {
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        });

        // Toggle UI
        let uiVisible = true;
        document.getElementById('toggleUIBtn')?.addEventListener('click', () => {
            uiVisible = !uiVisible;
            document.getElementById('readerHeader').style.transform = uiVisible ? 'translateY(0)' : 'translateY(-100%)';
            document.getElementById('readerFooter').style.transform = uiVisible ? 'translateY(0)' : 'translateY(100%)';
        });

        // Auto hide/show header on scroll
        let lastScroll = 0;
        window.addEventListener('scroll', () => {
            const header = document.getElementById('readerHeader');
            const footer = document.getElementById('readerFooter');
            const currentScroll = window.scrollY;

            // Progress bar
            const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
            const progress = (currentScroll / scrollHeight) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;

            // Hide/Show on scroll
            if (currentScroll > lastScroll && currentScroll > 100) {
                header.classList.add('hidden');
                footer.classList.add('hidden');
            } else {
                header.classList.remove('hidden');
                footer.classList.remove('hidden');
            }
            lastScroll = currentScroll;
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                const prevBtn = document.querySelector('.footer-btn.prev');
                if (prevBtn && !prevBtn.classList.contains('disabled')) prevBtn.click();
            }
            if (e.key === 'ArrowRight') {
                const nextBtn = document.querySelector('.footer-btn.next');
                if (nextBtn && !nextBtn.classList.contains('disabled')) nextBtn.click();
            }
        });

        // Retry loading
        document.getElementById('retryBtn')?.addEventListener('click', async () => {
            const btn = document.getElementById('retryBtn');
            btn.textContent = 'â³ Äang táº£i...';
            btn.disabled = true;

            try {
                const resp = await fetch('/api/crawl/chapter/{{ manga_id }}/{{ chapter.id }}', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('âŒ Lá»—i: ' + data.error);
                    btn.textContent = 'ğŸ”„ Táº£i láº¡i';
                    btn.disabled = false;
                }
            } catch (err) {
                alert('âŒ Lá»—i káº¿t ná»‘i');
                btn.textContent = 'ğŸ”„ Táº£i láº¡i';
                btn.disabled = false;
            }
        });

        // Preload and auto-download next chapter
        {% if next_chapter %}
        window.addEventListener('load', async () => {
            // Prefetch link
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = '/reader/{{ manga_id }}/{{ next_chapter.id }}';
            document.head.appendChild(link);

            // Check and auto-download next chapter
            await prefetchNextChapter();
        });

        async function prefetchNextChapter() {
            const nextChapterId = '{{ next_chapter.id }}';
            const mangaId = '{{ manga_id }}';
            
            try {
                // Kiá»ƒm tra chapter tiáº¿p theo Ä‘Ã£ táº£i chÆ°a
                const checkResp = await fetch(`/api/check-chapter/${mangaId}/${nextChapterId}`);
                const checkData = await checkResp.json();
                
                if (!checkData.downloaded) {
                    console.log(`ğŸ“¥ Tá»± Ä‘á»™ng táº£i trÆ°á»›c chapter: ${nextChapterId}`);
                    
                    // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o nhá»
                    showPrefetchNotice(`Äang táº£i trÆ°á»›c: {{ next_chapter.name }}`);
                    
                    // Táº£i chapter tiáº¿p theo
                    const downloadResp = await fetch(`/api/crawl/chapter/${mangaId}/${nextChapterId}`, {
                        method: 'POST'
                    });
                    const downloadData = await downloadResp.json();
                    
                    if (downloadData.success) {
                        showPrefetchNotice(`âœ… ÄÃ£ táº£i xong: {{ next_chapter.name }} (${downloadData.images} áº£nh)`, 3000);
                    }
                }
            } catch (e) {
                console.log('Prefetch error:', e);
            }
        }

        function showPrefetchNotice(text, duration = 0) {
            let notice = document.getElementById('prefetchNotice');
            if (!notice) {
                notice = document.createElement('div');
                notice.id = 'prefetchNotice';
                notice.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    right: 20px;
                    background: rgba(99, 102, 241, 0.95);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    transition: opacity 0.3s;
                `;
                document.body.appendChild(notice);
            }
            notice.textContent = text;
            notice.style.opacity = '1';
            
            if (duration > 0) {
                setTimeout(() => {
                    notice.style.opacity = '0';
                    setTimeout(() => notice.remove(), 300);
                }, duration);
            }
        }
        {% endif %}
        
        // User dropdown menu toggle
        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            const userDropdown = document.getElementById('userDropdown');
            if (userDropdown && !e.target.closest('.user-dropdown')) {
                userDropdown.classList.remove('show');
            }
        });
    </script>
</body>

</html>