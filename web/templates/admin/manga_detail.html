<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ story.title }} - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        .admin-sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .admin-main {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            background: var(--bg-primary);
            min-height: 100vh;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .sidebar-logo-icon {
            font-size: 32px;
        }

        .sidebar-logo-text {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav-item {
            margin-bottom: 4px;
        }

        .sidebar-nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 10px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
        }

        .sidebar-nav-link:hover,
        .sidebar-nav-link.active {
            background: var(--bg-tertiary);
            color: var(--primary);
        }

        .sidebar-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .sidebar-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
            margin-bottom: 12px;
            padding-left: 16px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .admin-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .admin-section {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .manga-info {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .manga-cover {
            width: 200px;
            height: 280px;
            border-radius: 12px;
            object-fit: cover;
        }

        .manga-details {
            flex: 1;
            min-width: 300px;
        }

        .manga-details h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .detail-row {
            display: flex;
            margin-bottom: 12px;
        }

        .detail-label {
            width: 120px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .detail-value {
            color: var(--text-primary);
        }

        .genre-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .genre-tag {
            padding: 4px 12px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            border-radius: 20px;
            font-size: 13px;
        }

        .stats-row {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .progress-section {
            margin-top: 20px;
        }

        .progress-bar-large {
            height: 12px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 6px;
            transition: width 0.5s;
        }

        .progress-text {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chapter-section {
            max-height: 400px;
            overflow-y: auto;
        }

        .chapter-list {
            display: grid;
            gap: 8px;
        }

        .chapter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .chapter-item:hover {
            background: var(--bg-primary);
        }

        .chapter-item.downloaded {
            border-left: 3px solid #22c55e;
        }

        .chapter-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .chapter-status {
            font-size: 12px;
        }

        .status-downloaded {
            color: #22c55e;
        }

        .status-pending {
            color: var(--text-secondary);
        }

        .btn-download-chapter {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-download-chapter:hover {
            background: var(--secondary);
        }

        .btn-download-chapter:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .download-all-progress {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: none;
        }

        .download-all-progress.active {
            display: block;
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-logo">
                <span class="sidebar-logo-icon">üìö</span>
                <span class="sidebar-logo-text">Admin Panel</span>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_dashboard') }}"
                        class="sidebar-nav-link"><span>üìä</span> Dashboard</a></li>
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_manga_list') }}"
                        class="sidebar-nav-link active"><span>üìñ</span> Qu·∫£n l√Ω Manga</a></li>
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_manga_add') }}"
                        class="sidebar-nav-link"><span>‚ûï</span> Th√™m Manga</a></li>
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_users') }}"
                        class="sidebar-nav-link"><span>üë•</span> Qu·∫£n l√Ω Users</a></li>
            </ul>
            <div class="sidebar-section">
                <div class="sidebar-section-title">Trang web</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="{{ url_for('index') }}"
                            class="sidebar-nav-link"><span>üè†</span> Trang ch·ªß</a></li>
                    <li class="sidebar-nav-item"><a href="{{ url_for('logout') }}"
                            class="sidebar-nav-link"><span>üö™</span> ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <div>
                    <a href="{{ url_for('admin_manga_list') }}"
                        style="color: var(--text-secondary); text-decoration: none; font-size: 14px;">‚Üê Quay l·∫°i</a>
                    <h1 class="admin-title" style="margin-top: 8px;">{{ story.title }}</h1>
                </div>
                <div class="header-actions">
                    <a href="{{ url_for('story', manga_id=story.id) }}" class="btn btn-outline" target="_blank">üîó Xem
                        truy·ªán</a>
                    <form action="{{ url_for('admin_manga_refresh', manga_id=story.id) }}" method="POST"
                        style="display:inline">
                        <button type="submit" class="btn btn-primary">üîÑ C·∫≠p nh·∫≠t</button>
                    </form>
                    <form action="{{ url_for('admin_manga_delete', manga_id=story.id) }}" method="POST"
                        style="display:inline"
                        onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a truy·ªán n√†y v√† t·∫•t c·∫£ d·ªØ li·ªáu li√™n quan?')">
                        <button type="submit" class="btn btn-danger">üóëÔ∏è X√≥a</button>
                    </form>
                </div>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- Manga Info -->
            <div class="admin-section">
                <div class="manga-info">
                    <img src="{{ story.thumbnail or 'https://via.placeholder.com/200x280?text=No+Image' }}"
                        alt="{{ story.title }}" class="manga-cover"
                        onerror="this.src='https://via.placeholder.com/200x280?text=No+Image'">
                    <div class="manga-details">
                        <h2>{{ story.title }}</h2>

                        <div class="detail-row">
                            <span class="detail-label">ID:</span>
                            <span class="detail-value"><code>{{ story.id }}</code></span>
                        </div>

                        {% if story.author %}
                        <div class="detail-row">
                            <span class="detail-label">T√°c gi·∫£:</span>
                            <span class="detail-value">{{ story.author }}</span>
                        </div>
                        {% endif %}

                        {% if story.status %}
                        <div class="detail-row">
                            <span class="detail-label">Tr·∫°ng th√°i:</span>
                            <span class="detail-value">{{ story.status }}</span>
                        </div>
                        {% endif %}

                        {% if story.genres %}
                        <div class="detail-row">
                            <span class="detail-label">Th·ªÉ lo·∫°i:</span>
                            <div class="genre-tags">
                                {% for genre in story.genres %}
                                <span class="genre-tag">{{ genre }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="stats-row">
                            <div class="stat-item">
                                <div class="stat-value">{{ story.total_chapters }}</div>
                                <div class="stat-label">Chapters</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ download_status.downloaded }}</div>
                                <div class="stat-label">ƒê√£ t·∫£i</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ download_status.percentage }}%</div>
                                <div class="stat-label">Ho√†n th√†nh</div>
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-bar-large">
                                <div class="progress-fill" style="width: {{ download_status.percentage }}%"></div>
                            </div>
                            <p class="progress-text">{{ download_status.downloaded }}/{{ download_status.total }}
                                chapters ƒë√£ t·∫£i l√™n cloud</p>
                        </div>

                        <div style="margin-top: 20px;">
                            <button id="downloadAllBtn" class="btn btn-primary btn-lg">
                                üì• T·∫£i t·∫•t c·∫£ chapters
                            </button>
                        </div>

                        <div class="download-all-progress" id="downloadProgress">
                            <p><strong>üì• ƒêang t·∫£i...</strong></p>
                            <div class="progress-bar-large" style="margin: 10px 0;">
                                <div class="progress-fill" id="downloadProgressBar" style="width: 0%"></div>
                            </div>
                            <p id="downloadStatus">0/{{ story.total_chapters }} chapters</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chapters -->
            <div class="admin-section">
                <h3 style="margin-bottom: 16px; color: var(--text-primary);">üìë Danh s√°ch Chapters</h3>
                <div class="chapter-section">
                    <div class="chapter-list">
                        {% for chapter in story.chapters %}
                        <div class="chapter-item {% if chapter.id in downloaded_chapters %}downloaded{% endif %}"
                            data-chapter-id="{{ chapter.id }}">
                            <div>
                                <span class="chapter-name">{{ chapter.name }}</span>
                                <span
                                    class="chapter-status {% if chapter.id in downloaded_chapters %}status-downloaded{% else %}status-pending{% endif %}">
                                    {% if chapter.id in downloaded_chapters %}‚úÖ ƒê√£ t·∫£i{% else %}‚è≥ Ch∆∞a t·∫£i{% endif %}
                                </span>
                            </div>
                            <button class="btn-download-chapter"
                                onclick="downloadChapter('{{ story.id }}', '{{ chapter.id }}', this)" {% if chapter.id
                                in downloaded_chapters %}disabled{% endif %}>
                                {% if chapter.id in downloaded_chapters %}‚úì{% else %}üì• T·∫£i{% endif %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        async function downloadChapter(mangaId, chapterId, btn) {
            btn.disabled = true;
            btn.textContent = '‚è≥...';

            try {
                const resp = await fetch(`/api/admin/download-chapter/${mangaId}/${chapterId}`, { method: 'POST' });
                const data = await resp.json();

                if (data.success) {
                    btn.textContent = '‚úì';
                    btn.closest('.chapter-item').classList.add('downloaded');
                    const status = btn.closest('.chapter-item').querySelector('.chapter-status');
                    status.textContent = '‚úÖ ƒê√£ t·∫£i';
                    status.classList.remove('status-pending');
                    status.classList.add('status-downloaded');
                } else {
                    btn.textContent = '‚ùå';
                    alert('L·ªói: ' + data.error);
                }
            } catch (e) {
                btn.textContent = '‚ùå';
                alert('L·ªói k·∫øt n·ªëi');
            }
        }

        document.getElementById('downloadAllBtn')?.addEventListener('click', async function () {
            const btn = this;
            const progressDiv = document.getElementById('downloadProgress');
            const progressBar = document.getElementById('downloadProgressBar');
            const statusText = document.getElementById('downloadStatus');

            if (!confirm('T·∫£i t·∫•t c·∫£ {{ story.total_chapters }} chapters?\nQu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t nhi·ªÅu th·ªùi gian.')) return;

            btn.disabled = true;
            btn.textContent = '‚è≥ ƒêang t·∫£i...';
            progressDiv.classList.add('active');

            try {
                const response = await fetch('/api/download-all/{{ story.id }}', { method: 'POST' });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                let downloaded = 0;
                const total = {{ story.total_chapters }
            };

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const text = decoder.decode(value);
                const lines = text.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.type === 'progress') {
                                downloaded = data.current;
                                progressBar.style.width = `${(downloaded / total) * 100}%`;
                                statusText.textContent = `${downloaded}/${total} chapters - ${data.chapter}`;

                                // Update chapter item UI
                                const chapterItem = document.querySelector(`[data-chapter-id="${data.chapter}"]`);
                                if (chapterItem) {
                                    chapterItem.classList.add('downloaded');
                                    const status = chapterItem.querySelector('.chapter-status');
                                    status.textContent = '‚úÖ ƒê√£ t·∫£i';
                                    status.classList.add('status-downloaded');
                                    const btn = chapterItem.querySelector('.btn-download-chapter');
                                    btn.textContent = '‚úì';
                                    btn.disabled = true;
                                }
                            } else if (data.type === 'complete') {
                                statusText.textContent = `Ho√†n th√†nh! ${data.downloaded}/${data.total} chapters`;
                                alert('‚úÖ T·∫£i ho√†n th√†nh!');
                                location.reload();
                            }
                        } catch (e) { }
                    }
                }
            }
        } catch (e) {
            alert('L·ªói: ' + e.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üì• T·∫£i t·∫•t c·∫£ chapters';
        }
        });
    </script>
</body>

</html>