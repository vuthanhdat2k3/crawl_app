<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Users - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .admin-layout { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
        .admin-main { flex: 1; margin-left: 260px; padding: 30px; background: var(--bg-primary); min-height: 100vh; }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .sidebar-logo-icon { font-size: 32px; }
        .sidebar-logo-text { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .sidebar-nav { list-style: none; padding: 0; margin: 0; }
        .sidebar-nav-item { margin-bottom: 4px; }
        .sidebar-nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-secondary); text-decoration: none; font-weight: 500; transition: all 0.2s; }
        .sidebar-nav-link:hover, .sidebar-nav-link.active { background: var(--bg-tertiary); color: var(--primary); }
        .sidebar-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .sidebar-section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-tertiary); margin-bottom: 12px; padding-left: 16px; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 20px; flex-wrap: wrap; }
        .admin-title { font-size: 24px; font-weight: 700; color: var(--text-primary); }
        .admin-section { background: var(--bg-secondary); border-radius: 16px; padding: 24px; border: 1px solid var(--border-color); margin-bottom: 24px; }
        .search-box { display: flex; gap: 12px; margin-bottom: 20px; }
        .search-box input { flex: 1; padding: 12px 16px; border-radius: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 14px; }
        .search-box input:focus { border-color: var(--primary); outline: none; }
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th, .user-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .user-table th { font-weight: 600; color: var(--text-secondary); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; background: var(--bg-tertiary); }
        .user-table tr:hover { background: var(--bg-tertiary); }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white; }
        .user-name { font-weight: 600; color: var(--text-primary); }
        .user-email { font-size: 13px; color: var(--text-secondary); }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .badge-admin { background: rgba(99, 102, 241, 0.2); color: var(--primary); }
        .badge-user { background: rgba(156, 163, 175, 0.2); color: var(--text-secondary); }
        .badge-active { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge-inactive { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .user-actions { display: flex; gap: 8px; }
        .btn-icon { width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: all 0.2s; }
        .btn-icon-toggle { background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .btn-icon-toggle:hover { border-color: var(--primary); color: var(--primary); }
        .btn-icon-admin { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .btn-icon-admin:hover { background: var(--primary); color: white; }
        .btn-icon-delete { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .btn-icon-delete:hover { background: #ef4444; color: white; }
        .alert { padding: 12px 16px; border-radius: 10px; margin-bottom: 20px; font-size: 14px; }
        .alert-success { background: rgba(34, 197, 94, 0.1); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.2); }
        .alert-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); }
        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 20px; }
        .pagination a { padding: 8px 14px; background: var(--bg-tertiary); border-radius: 8px; color: var(--text-secondary); text-decoration: none; font-weight: 500; transition: all 0.2s; }
        .pagination a:hover, .pagination a.active { background: var(--primary); color: white; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border-radius: 16px; padding: 24px; width: 90%; max-width: 400px; border: 1px solid var(--border-color); }
        .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .modal-form { display: flex; flex-direction: column; gap: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: var(--text-secondary); font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 12px 14px; border-radius: 10px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); font-size: 14px; }
        .form-group input:focus, .form-group select:focus { border-color: var(--primary); outline: none; }
        .modal-actions { display: flex; gap: 12px; margin-top: 8px; }
        .modal-actions button { flex: 1; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-logo">
                <span class="sidebar-logo-icon">üìö</span>
                <span class="sidebar-logo-text">Admin Panel</span>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_dashboard') }}" class="sidebar-nav-link"><span>üìä</span> Dashboard</a></li>
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_manga_list') }}" class="sidebar-nav-link"><span>üìñ</span> Qu·∫£n l√Ω Manga</a></li>
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_manga_add') }}" class="sidebar-nav-link"><span>‚ûï</span> Th√™m Manga</a></li>
                <li class="sidebar-nav-item"><a href="{{ url_for('admin_users') }}" class="sidebar-nav-link active"><span>üë•</span> Qu·∫£n l√Ω Users</a></li>
            </ul>
            <div class="sidebar-section">
                <div class="sidebar-section-title">Trang web</div>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-item"><a href="{{ url_for('index') }}" class="sidebar-nav-link"><span>üè†</span> Trang ch·ªß</a></li>
                    <li class="sidebar-nav-item"><a href="{{ url_for('logout') }}" class="sidebar-nav-link"><span>üö™</span> ƒêƒÉng xu·∫•t</a></li>
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <div class="admin-header">
                <h1 class="admin-title">üë• Qu·∫£n l√Ω Users</h1>
                <button class="btn btn-primary" onclick="openAddModal()">‚ûï Th√™m User</button>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Search -->
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm theo t√™n ho·∫∑c email..." onkeyup="filterUsers()">
            </div>

            <!-- Users Table -->
            <div class="admin-section" style="overflow-x: auto;">
                {% if users %}
                <table class="user-table" id="userTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr data-user-id="{{ user._id }}">
                            <td>
                                <div class="user-info">
                                    <div class="user-avatar">{{ user.username[0].upper() }}</div>
                                    <div>
                                        <div class="user-name">{{ user.username }}</div>
                                        <div class="user-email">{{ user.email or 'No email' }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge {% if user.role == 'admin' %}badge-admin{% else %}badge-user{% endif %}">
                                    {% if user.role == 'admin' %}üëë Admin{% else %}üë§ User{% endif %}
                                </span>
                            </td>
                            <td>
                                <span class="badge {% if user.is_active %}badge-active{% else %}badge-inactive{% endif %}">
                                    {% if user.is_active %}‚úÖ Active{% else %}‚õî Inactive{% endif %}
                                </span>
                            </td>
                            <td style="color: var(--text-secondary); font-size: 13px;">
                                {{ user.created_at.strftime('%d/%m/%Y %H:%M') if user.created_at else 'N/A' }}
                            </td>
                            <td>
                                <div class="user-actions">
                                    <!-- Toggle Active -->
                                    <form action="{{ url_for('admin_toggle_user', user_id=user._id) }}" method="POST" style="display:inline">
                                        <button type="submit" class="btn-icon btn-icon-toggle" 
                                                title="{% if user.is_active %}V√¥ hi·ªáu h√≥a{% else %}K√≠ch ho·∫°t{% endif %}">
                                            {% if user.is_active %}üîí{% else %}üîì{% endif %}
                                        </button>
                                    </form>
                                    
                                    <!-- Toggle Admin -->
                                    {% if user.username != 'admin' %}
                                    <form action="{{ url_for('admin_toggle_admin', user_id=user._id) }}" method="POST" style="display:inline">
                                        <button type="submit" class="btn-icon btn-icon-admin" title="Toggle Admin">
                                            üëë
                                        </button>
                                    </form>
                                    {% endif %}
                                    
                                    <!-- Delete -->
                                    {% if user.username != 'admin' %}
                                    <form action="{{ url_for('admin_delete_user', user_id=user._id) }}" method="POST" style="display:inline"
                                          onsubmit="return confirm('X√≥a user {{ user.username }}?')">
                                        <button type="submit" class="btn-icon btn-icon-delete" title="X√≥a">üóëÔ∏è</button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <p>Ch∆∞a c√≥ user n√†o</p>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <!-- Add User Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <h2 class="modal-title">‚ûï Th√™m User m·ªõi</h2>
            <form action="{{ url_for('admin_add_user') }}" method="POST" class="modal-form">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" name="username" required placeholder="Nh·∫≠p username">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" placeholder="Nh·∫≠p email (t√πy ch·ªçn)">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select name="is_admin">
                        <option value="0">üë§ User</option>
                        <option value="1">üëë Admin</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeAddModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">T·∫°o User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function filterUsers() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#userTable tbody tr');
            
            rows.forEach(row => {
                const name = row.querySelector('.user-name').textContent.toLowerCase();
                const email = row.querySelector('.user-email').textContent.toLowerCase();
                row.style.display = (name.includes(search) || email.includes(search)) ? '' : 'none';
            });
        }

        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddModal();
        });
    </script>
</body>
</html>
