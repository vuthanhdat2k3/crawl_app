<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ story.title }} - Manga Heaven</title>
  <meta name="description" content="{{ story.description[:150] if story.description else story.title }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Header -->
  <header class="header">
    <nav class="nav container">
      <a href="/" class="logo">
        <span class="logo-icon">ğŸ“š</span>
        <span class="logo-text hide-mobile">MANGA<span class="highlight">HEAVEN</span></span>
      </a>

      <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>

      <div class="nav-links" id="navLinks">
        <a href="/" class="nav-link">ğŸ  <span>Trang chá»§</span></a>
        <a href="/search" class="nav-link">ğŸ” <span>TÃ¬m kiáº¿m</span></a>
      </div>

      <div class="nav-actions">
        {% if current_user.is_authenticated %}
        <div class="user-dropdown">
          <button class="user-dropdown-btn" onclick="toggleUserMenu()">
            <span class="user-avatar-small">{{ current_user.username[0].upper() }}</span>
            <span class="hide-mobile">{{ current_user.username }}</span>
            <span class="dropdown-arrow">â–¼</span>
          </button>
          <div class="user-dropdown-menu" id="userDropdown">
            <a href="/account" class="dropdown-item">âš™ï¸ CÃ i Ä‘áº·t</a>
            {% if current_user.is_admin() %}
            <a href="/admin" class="dropdown-item">ğŸ“Š Admin</a>
            {% endif %}
            <div class="dropdown-divider"></div>
            <a href="/logout" class="dropdown-item dropdown-item-danger">ğŸšª ÄÄƒng xuáº¥t</a>
          </div>
        </div>
        {% endif %}
      </div>
    </nav>
  </header>

  <!-- Story Detail -->
  <main class="story-page">
    <!-- Hero Banner -->
    <div class="story-hero">
      <div class="story-hero-bg" style="background-image: url('{{ story.thumbnail }}')"></div>
      <div class="container">
        <div class="story-header">
          <div class="story-cover">
            <img src="{{ story.thumbnail }}" alt="{{ story.title }}"
              onerror="this.src='https://via.placeholder.com/200x280?text=No+Image'">
          </div>
          <div class="story-meta">
            <h1 class="story-title">{{ story.title }}</h1>

            {% if story.author %}
            <div class="story-author">
              <span class="meta-icon">âœï¸</span>
              <span>{{ story.author }}</span>
            </div>
            {% endif %}

            {% if story.genres %}
            <div class="story-genres">
              {% for genre in story.genres %}
              <span class="genre-tag">{{ genre }}</span>
              {% endfor %}
            </div>
            {% endif %}

            <div class="story-stats">
              <div class="stat-item">
                <span class="stat-value">{{ story.total_chapters }}</span>
                <span class="stat-label">Chapters</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">HD</span>
                <span class="stat-label">Cháº¥t lÆ°á»£ng</span>
              </div>
            </div>

            {% if story.description %}
            <p class="story-description">{{ story.description }}</p>
            {% endif %}

            <div class="story-actions">
              {% if story.chapters %}
              <a href="/reader/{{ story.id }}/{{ story.chapters[-1].id }}" class="btn btn-primary btn-lg">
                ğŸ“– Äá»c tá»« Ä‘áº§u
              </a>
              <a href="/reader/{{ story.id }}/{{ story.chapters[0].id }}" class="btn btn-outline btn-lg">
                ğŸš€ Chap má»›i nháº¥t
              </a>
              {% endif %}
              <button id="refreshChapters" class="btn btn-ghost">
                ğŸ”„ Cáº­p nháº­t chapters
              </button>
              <button id="downloadAll" class="btn btn-secondary">
                ğŸ“¥ Táº£i táº¥t cáº£ (tá»« Ä‘áº§u)
              </button>
            </div>

            <!-- Download Progress -->
            <div id="downloadProgress" class="download-progress hidden">
              <div class="progress-header">
                <span class="progress-title">ğŸ“¥ Äang táº£i truyá»‡n...</span>
                <span class="progress-text"><span id="downloadedCount">0</span>/<span id="totalCount">0</span>
                  chapters</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
              </div>
              <div id="currentChapterInfo"
                style="margin-top: 12px; padding: 12px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; display: none;">
                <p style="margin: 0; font-size: 14px;">ğŸ“„ Äang táº£i: <strong id="currentChapterName">...</strong></p>
                <p id="chapterImageProgress" style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);">
                </p>
              </div>
              <p class="progress-note">âš ï¸ QuÃ¡ trÃ¬nh táº£i cÃ³ thá»ƒ máº¥t nhiá»u thá»i gian. Vui lÃ²ng khÃ´ng Ä‘Ã³ng
                trang.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chapter List -->
    <div class="container">
      <section class="chapter-section">
        <div class="section-header">
          <h2 class="section-title">
            <span class="title-icon">ğŸ“‘</span>
            Danh sÃ¡ch Chapters
          </h2>
          <div class="chapter-filter">
            <button class="filter-btn active" data-order="desc">Má»›i nháº¥t</button>
            <button class="filter-btn" data-order="asc">CÅ© nháº¥t</button>
          </div>
        </div>

        <div class="chapter-list" id="chapterList">
          {% for chapter in story.chapters %}
          <a href="/reader/{{ story.id }}/{{ chapter.id }}"
            class="chapter-item {% if chapter.id in downloaded_chapters %}downloaded{% endif %}">
            <span class="chapter-info">
              {% if chapter.id in downloaded_chapters %}
              <span class="download-status" title="ÄÃ£ táº£i vá»">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                </svg>
              </span>
              {% endif %}
              <span class="chapter-name">{{ chapter.name }}</span>
            </span>
            <span class="chapter-arrow">â†’</span>
          </a>
          {% endfor %}
        </div>

        {% if not story.chapters %}
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <h3>ChÆ°a cÃ³ chapter nÃ o</h3>
          <p>Nháº¥n "Cáº­p nháº­t chapters" Ä‘á»ƒ táº£i danh sÃ¡ch</p>
        </div>
        {% endif %}
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <p class="footer-text">
          <a href="/">â† Quay láº¡i trang chá»§</a>
        </p>
      </div>
    </div>
  </footer>

  <!-- Mobile Menu Overlay -->
  <div class="mobile-overlay" id="mobileOverlay"></div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Äang táº£i chapters...</p>
    </div>
  </div>

  <script>
    // Refresh chapters
    document.getElementById('refreshChapters')?.addEventListener('click', async function () {
      const overlay = document.getElementById('loadingOverlay');
      overlay.classList.remove('hidden');

      try {
        const response = await fetch('/api/crawl/story/{{ story.id }}', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          alert(`âœ… ÄÃ£ cáº­p nháº­t ${data.chapters} chapters!`);
          window.location.reload();
        } else {
          alert('âŒ Lá»—i: ' + data.error);
        }
      } catch (error) {
        alert('âŒ Lá»—i káº¿t ná»‘i: ' + error.message);
      } finally {
        overlay.classList.add('hidden');
      }
    });

    // Sort chapters
    const filterBtns = document.querySelectorAll('.filter-btn');
    const chapterList = document.getElementById('chapterList');

    filterBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        filterBtns.forEach(b => b.classList.remove('active'));
        this.classList.add('active');

        const items = Array.from(chapterList.children);
        if (this.dataset.order === 'asc') {
          items.reverse();
        } else {
          items.sort((a, b) => {
            const aNum = parseInt(a.textContent.match(/\d+/)?.[0] || 0);
            const bNum = parseInt(b.textContent.match(/\d+/)?.[0] || 0);
            return bNum - aNum;
          });
        }
        items.forEach(item => chapterList.appendChild(item));
      });
    });

    // Download all chapters with SSE streaming
    document.getElementById('downloadAll')?.addEventListener('click', async function () {
      const btn = this;
      const progressDiv = document.getElementById('downloadProgress');
      const progressBar = document.getElementById('progressBar');
      const downloadedCount = document.getElementById('downloadedCount');
      const totalCount = document.getElementById('totalCount');
      const currentChapterInfo = document.getElementById('currentChapterInfo');
      const currentChapterName = document.getElementById('currentChapterName');
      const chapterImageProgress = document.getElementById('chapterImageProgress');

      // XÃ¡c nháº­n trÆ°á»›c khi táº£i
      const confirmed = confirm('âš ï¸ Báº¡n cÃ³ cháº¯c muá»‘n táº£i toÃ n bá»™ {{ story.total_chapters }} chapters?\n\nSáº½ táº£i tá»« Chapter Ä‘áº§u tiÃªn Ä‘áº¿n má»›i nháº¥t.');
      if (!confirmed) return;

      // Hiá»ƒn thá»‹ progress
      btn.disabled = true;
      btn.textContent = 'â³ Äang táº£i...';
      progressDiv.classList.remove('hidden');
      currentChapterInfo.style.display = 'block';
      totalCount.textContent = '{{ story.total_chapters }}';

      let downloaded = 0;
      let total = {{ story.total_chapters }};

    try {
      // Sá»­ dá»¥ng SSE Ä‘á»ƒ nháº­n progress realtime
      const response = await fetch('/api/download-all/{{ story.id }}', {
        method: 'POST'
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const text = decoder.decode(value);
        const lines = text.split('\n');

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            try {
              const data = JSON.parse(line.slice(6));

              if (data.type === 'start') {
                total = data.total;
                totalCount.textContent = total;
              } else if (data.type === 'progress') {
                downloaded = data.current;
                downloadedCount.textContent = downloaded;
                progressBar.style.width = `${(downloaded / total) * 100}%`;
                currentChapterName.textContent = data.chapter;
                chapterImageProgress.textContent = `âœ… HoÃ n thÃ nh ${data.images} áº£nh`;

                // Cáº­p nháº­t UI chapter list
                const chapterItem = document.querySelector(`a[href*="/${data.chapter}"]`);
                if (chapterItem) {
                  chapterItem.classList.add('downloaded');
                }
              } else if (data.type === 'error' && data.chapter) {
                chapterImageProgress.textContent = `âŒ Lá»—i: ${data.error}`;
              } else if (data.type === 'complete') {
                progressBar.style.width = '100%';
                currentChapterName.textContent = 'HoÃ n thÃ nh!';
                chapterImageProgress.textContent = '';
                alert(`âœ… HoÃ n thÃ nh!\n\nÄÃ£ táº£i: ${data.downloaded}/${data.total} chapters` +
                  (data.errors && data.errors.length > 0 ? `\n\nLá»—i: ${data.errors.length} chapters` : ''));
                window.location.reload();
              }
            } catch (e) {
              console.log('Parse error:', e);
            }
          }
        }
      }
    } catch (error) {
      alert('âŒ Lá»—i káº¿t ná»‘i: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ“¥ Táº£i táº¥t cáº£ (tá»« Ä‘áº§u)';
    }
    });

    // Check download status on page load
    async function checkDownloadStatus() {
      try {
        const response = await fetch('/api/download-status/{{ story.id }}');
        const data = await response.json();

        if (data.downloaded > 0) {
          const statusText = document.createElement('p');
          statusText.className = 'download-status';
          statusText.innerHTML = `ğŸ“Š ÄÃ£ táº£i: <strong>${data.downloaded}</strong>/${data.total} chapters (${data.percentage}%)`;
          document.querySelector('.story-actions')?.after(statusText);
        }
      } catch (e) {
        console.log('KhÃ´ng thá»ƒ kiá»ƒm tra tráº¡ng thÃ¡i táº£i');
      }
    }
    checkDownloadStatus();

    // User dropdown menu toggle & Mobile Menu
    const navLinks = document.getElementById('navLinks');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const userDropdown = document.getElementById('userDropdown');

    function toggleMobileMenu() {
      const isOpen = navLinks.classList.contains('show');
      if (isOpen) {
        closeMobileMenu();
      } else {
        navLinks.classList.add('show');
        mobileOverlay.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
    }

    function closeMobileMenu() {
      navLinks.classList.remove('show');
      mobileOverlay.classList.remove('show');
      document.body.style.overflow = '';
    }

    function toggleUserMenu() {
      userDropdown.classList.toggle('show');
      if (window.innerWidth <= 768) {
        mobileOverlay.classList.toggle('show', userDropdown.classList.contains('show'));
      }
    }

    // Click outside
    document.addEventListener('click', function (e) {
      if (!e.target.closest('.user-dropdown') && userDropdown?.classList.contains('show')) {
        userDropdown.classList.remove('show');
        if (window.innerWidth <= 768 && !navLinks.classList.contains('show')) {
          mobileOverlay.classList.remove('show');
        }
      }
    });

    mobileOverlay?.addEventListener('click', function () {
      closeMobileMenu();
      userDropdown?.classList.remove('show');
    });

  </script>
</body>

</html>